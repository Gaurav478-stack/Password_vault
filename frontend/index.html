<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SecurePass Vault ‚Äî Improved</title>
  
  <!-- Screenshot Prevention Meta Tags -->
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --bg:#0f172a; --card:#0f172a; --muted:#94a3b8; --accent:#2563eb; --accent-dark:#1d4ed8; --text:#e6eef8;
      --danger:#dc2626; --success:#16a34a; --card-bg:#0f172a; --panel:#0f172a;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      background:linear-gradient(180deg,#071029 0%, var(--bg) 100%);
      color:var(--text); margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding:0;
    }
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;padding-bottom:18px}
    .logo{display:flex;align-items:center;gap:12px;font-weight:700;font-size:20px}
    .logo i{color:var(--accent);font-size:28px}
    button.btn{cursor:pointer;padding:10px 14px;border-radius:8px;border:none;font-weight:600}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-outline{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .top-actions{display:flex;gap:10px;align-items:center}
    .vault-grid{display:grid;grid-template-columns:300px 1fr;gap:24px;margin-top:20px}
    .panel{background:rgba(255,255,255,0.03);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03)}
    .search{position:relative}
    .search input{width:100%;padding:10px 12px 10px 36px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
    .search i{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--muted)}
    .category-list{list-style:none;padding:0;margin:10px 0 0;display:flex;flex-direction:column;gap:8px}
    .category-item{padding:10px;border-radius:8px;display:flex;gap:10px;align-items:center;cursor:pointer;color:var(--muted)}
    .category-item.active{background:rgba(37,99,235,0.12);color:var(--text)}
    .content-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .password-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .card{background:rgba(255,255,255,0.02);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
    .card .row{display:flex;align-items:center;justify-content:space-between}
    .password-value{font-family:monospace;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;gap:8px}
    .action-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px}
    .action-btn:hover{color:var(--text)}
    .modal{position:fixed;inset:0;background:rgba(2,6,23,0.7);display:flex;align-items:center;justify-content:center;z-index:60}
    .modal-content{width:100%;max-width:520px;background:rgba(255,255,255,0.02);padding:22px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text],input[type=url],input[type=password],select{width:100%;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
    .form-row{margin-bottom:12px}
    .strength-meter{height:6px;border-radius:6px;background:rgba(255,255,255,0.03);overflow:hidden}
    .strength-fill{height:100%;width:0%;transition:width .2s}
    .strength-weak{background:var(--danger)}
    .strength-medium{background:#f59e0b}
    .strength-strong{background:var(--success)}
    .empty{padding:36px;text-align:center;color:var(--muted)}
    footer.note{margin-top:18px;color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;align-items:center}
    .small{padding:6px 8px;font-size:13px;border-radius:8px}
    .hidden{display:none}
    @media (max-width:820px){
      .vault-grid{grid-template-columns:1fr}
      .search{margin-bottom:12px}
      .hero-title{font-size:36px; padding:0 20px}
      .hero-subtitle{padding:0 20px; font-size:16px}
      .hero-buttons{flex-direction:column; width:100%; max-width:300px; margin:0 auto; padding:0 20px}
      .btn-hero{width:100%}
      .features-grid{grid-template-columns:1fr}
      .stats-grid{grid-template-columns:1fr}
      .top-actions{flex-wrap:wrap}
    }
    
    /* Screenshot Prevention Styles */
    .password-value.secure-blur {
      filter: blur(8px);
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    .no-screenshot-warning {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(220, 38, 38, 0.9);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      z-index: 9999;
      display: none;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .screenshot-overlay {
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 99999;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 20px;
    }
    .screenshot-overlay h1 {
      color: #dc2626;
      font-size: 48px;
      margin: 0;
    }
    .screenshot-overlay p {
      color: #fff;
      font-size: 20px;
    }
    
    /* Homepage Styles */
    #homepage {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      opacity: 1;
      transition: opacity 0.5s ease;
    }
    #homepage.fade-out {
      opacity: 0;
    }
    .hero-section {
      text-align: center;
      padding: 80px 20px 60px;
      animation: fadeInUp 0.8s ease;
    }
    .hero-title {
      font-size: 56px;
      font-weight: 800;
      margin: 0 0 20px;
      background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: fadeInUp 0.8s ease 0.2s both;
    }
    .hero-subtitle {
      font-size: 20px;
      color: var(--muted);
      margin: 0 0 40px;
      animation: fadeInUp 0.8s ease 0.4s both;
    }
    .hero-buttons {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
      animation: fadeInUp 0.8s ease 0.6s both;
    }
    .btn-hero {
      padding: 16px 32px;
      font-size: 16px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      border: none;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn-hero:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(37, 99, 235, 0.3);
    }
    .btn-hero-primary {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
    }
    .btn-hero-outline {
      background: transparent;
      border: 2px solid rgba(255, 255, 255, 0.1);
      color: var(--text);
    }
    .features-section {
      padding: 60px 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-top: 40px;
    }
    .feature-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      animation: fadeInUp 0.8s ease both;
      transition: transform 0.3s, border-color 0.3s;
    }
    .feature-card:nth-child(1) { animation-delay: 0.1s; }
    .feature-card:nth-child(2) { animation-delay: 0.2s; }
    .feature-card:nth-child(3) { animation-delay: 0.3s; }
    .feature-card:nth-child(4) { animation-delay: 0.4s; }
    .feature-card:nth-child(5) { animation-delay: 0.5s; }
    .feature-card:nth-child(6) { animation-delay: 0.6s; }
    .feature-card:hover {
      transform: translateY(-5px);
      border-color: rgba(37, 99, 235, 0.3);
    }
    .feature-icon {
      font-size: 48px;
      margin-bottom: 20px;
      background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .feature-title {
      font-size: 20px;
      font-weight: 700;
      margin: 0 0 12px;
      color: var(--text);
    }
    .feature-description {
      font-size: 14px;
      color: var(--muted);
      line-height: 1.6;
      margin: 0;
    }
    .section-title {
      text-align: center;
      font-size: 40px;
      font-weight: 700;
      margin: 0 0 16px;
      color: var(--text);
    }
    .section-subtitle {
      text-align: center;
      font-size: 18px;
      color: var(--muted);
      margin: 0;
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    #vaultApp {
      display: none;
      animation: fadeIn 0.5s ease;
      padding: 24px;
    }
    #vaultApp.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .scroll-indicator {
      position: absolute;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      animation: bounce 2s infinite;
    }
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateX(-50%) translateY(0); }
      40% { transform: translateX(-50%) translateY(-10px); }
      60% { transform: translateX(-50%) translateY(-5px); }
    }
    .stats-section {
      padding: 40px 20px;
      text-align: center;
      animation: fadeInUp 0.8s ease 0.7s both;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 32px;
      max-width: 800px;
      margin: 0 auto;
    }
    .stat-item {
      padding: 20px;
    }
    .stat-number {
      font-size: 48px;
      font-weight: 800;
      background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0 0 8px;
    }
    .stat-label {
      font-size: 16px;
      color: var(--muted);
      margin: 0;
    }
  </style>
</head>
<body>
  <!-- Homepage -->
  <div id="homepage">
    <div class="hero-section">
      <h1 class="hero-title">Isolate Your Identities</h1>
      <p class="hero-subtitle">üîê Military-grade encryption ‚Ä¢ üïµÔ∏è Zero-knowledge ‚Ä¢ üíæ Encrypted backups ‚Ä¢ ‚ö° Instant setup</p>
      <div class="hero-buttons">
        <button class="btn-hero btn-hero-primary" onclick="startVault()">
          <i class="fas fa-lock"></i> Open Vault
        </button>
        <button class="btn-hero btn-hero-outline" onclick="resetVaultFromHome()" style="border-color: rgba(239, 68, 68, 0.3); color: #ef4444;">
          <i class="fas fa-trash-restore"></i> Reset Vault
        </button>
        <button class="btn-hero btn-hero-outline" onclick="scrollToFeatures()">
          <i class="fas fa-info-circle"></i> Learn More
        </button>
      </div>
      <div style="margin-top: 24px; padding: 16px 24px; background: rgba(255, 255, 255, 0.03); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.05); max-width: 600px; margin-left: auto; margin-right: auto; animation: fadeInUp 0.8s ease 0.7s both;">
        <p style="margin: 0; font-size: 13px; color: var(--muted); line-height: 1.6;">
          <i class="fas fa-info-circle" style="color: #2563eb;"></i> <strong style="color: var(--text);">First time?</strong> Click "Open Vault" to create your secure password vault.<br>
          <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i> <strong style="color: #ef4444;">Reset Vault</strong> permanently deletes all data. Only use if you forgot your master password or want to start fresh.
        </p>
      </div>
    </div>

    <div class="stats-section">
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-number">256</div>
          <p class="stat-label">Bit Encryption</p>
        </div>
        <div class="stat-item">
          <div class="stat-number">150K</div>
          <p class="stat-label">PBKDF2 Iterations</p>
        </div>
        <div class="stat-item">
          <div class="stat-number">0</div>
          <p class="stat-label">Servers Required</p>
        </div>
      </div>
    </div>

    <div class="features-section" id="features">
      <h2 class="section-title">Why SecurePass Vault?</h2>
      <p class="section-subtitle">Maximum security with zero compromises</p>
      
      <div class="features-grid">
        <div class="feature-card">
          <div class="feature-icon"><i class="fas fa-shield-alt"></i></div>
          <h3 class="feature-title">AES-256-GCM</h3>
          <p class="feature-description">Military-grade authenticated encryption ensures your passwords are protected with the highest security standards</p>
        </div>
        
        <div class="feature-card">
          <div class="feature-icon"><i class="fas fa-user-secret"></i></div>
          <h3 class="feature-title">Zero-Knowledge</h3>
          <p class="feature-description">Your master password never leaves your device. Not even we can access your passwords</p>
        </div>
        
        <div class="feature-card">
          <div class="feature-icon"><i class="fas fa-download"></i></div>
          <h3 class="feature-title">Encrypted Backups</h3>
          <p class="feature-description">Export and import your vault safely. Backup files remain encrypted and secure</p>
        </div>
        
        <div class="feature-card">
          <div class="feature-icon"><i class="fas fa-bolt"></i></div>
          <h3 class="feature-title">Instant Setup</h3>
          <p class="feature-description">No registration, no servers, no installation. Just open and start using immediately</p>
        </div>
        
        <div class="feature-card">
          <div class="feature-icon"><i class="fas fa-camera-slash"></i></div>
          <h3 class="feature-title">Screenshot Protection</h3>
          <p class="feature-description">Advanced detection blocks screenshots, screen recording, and unauthorized captures</p>
        </div>
        
        <div class="feature-card">
          <div class="feature-icon"><i class="fas fa-dollar-sign"></i></div>
          <h3 class="feature-title">100% Free</h3>
          <p class="feature-description">No subscriptions, no hidden costs. Completely free and open source forever</p>
        </div>
      </div>
    </div>
    
    <div style="padding: 60px 20px 40px; text-align: center; animation: fadeInUp 0.8s ease 0.8s both;">
      <p style="color: var(--muted); font-size: 14px; margin: 0;">
        üîí <strong>Privacy First</strong> ‚Ä¢ Made with ‚ù§Ô∏è for security-conscious users
      </p>
      <p style="color: var(--muted); font-size: 13px; margin: 8px 0 0;">
        Open Source ‚Ä¢ Zero Tracking ‚Ä¢ 100% Free Forever
      </p>
    </div>
  </div>

  <!-- Vault Application -->
  <div id="vaultApp">
  <div class="container">
    <header>
      <div class="logo">
        <i class="fas fa-shield-alt"></i>
        <div>
          <div>SecurePass Vault</div>
          <small style="color:var(--muted);font-weight:600;font-size:12px">Encrypted local vault (client-side)</small>
        </div>
      </div>

      <div class="top-actions">
        <button class="btn btn-outline" id="homeBtn" title="Back to homepage" onclick="goHome()"><i class="fas fa-home"></i></button>
        <button class="btn btn-outline" id="exportBtn" title="Export encrypted vault">Export</button>
        <button class="btn btn-outline" id="importBtn" title="Import encrypted vault">Import</button>
        <button class="btn btn-outline" id="resetVaultBtn" title="Reset vault (clears all data)" style="color:#ef4444">Reset</button>
        <button class="btn btn-primary" id="lockBtn" title="Lock/Unlock vault">Lock</button>
      </div>
    </header>

    <!-- Login / Register modal -->
    <div id="authModal" class="modal hidden" aria-hidden="true">
      <div class="modal-content">
        <h2 id="authTitle">Unlock Your Vault</h2>
        <div class="form-row">
          <label for="authUsername">Username (optional)</label>
          <input id="authUsername" type="text" placeholder="Optional name (local only)">
        </div>
        <div class="form-row">
          <label for="authPassword">Master password</label>
          <input id="authPassword" type="password" placeholder="Enter a strong master password">
        </div>
        <div style="display:flex;justify-content:space-between;gap:8px">
          <button class="btn btn-outline small" id="authCancel">Cancel</button>
          <button class="btn btn-primary small" id="authSubmit">Submit</button>
        </div>
        <p style="margin-top:10px;color:var(--muted);font-size:13px">The master password is never stored. It derives the encryption key locally.</p>
      </div>
    </div>

    <div class="vault-grid" id="vaultArea" style="display:none">
      <!-- Sidebar -->
      <aside class="panel">
        <div class="search">
          <i class="fas fa-search"></i>
          <input id="searchInput" placeholder="Search service or username...">
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="addBtn" class="btn btn-primary small"><i class="fas fa-plus"></i> Add</button>
          <button id="clearAllBtn" class="btn btn-outline small" title="Delete all (permanently)">Clear All</button>
        </div>

        <div style="margin-top:16px">
          <label>Category</label>
          <ul class="category-list" id="categories">
            <li class="category-item active" data-cat="">All Passwords</li>
            <li class="category-item" data-cat="banking"><i class="fas fa-credit-card"></i> Banking</li>
            <li class="category-item" data-cat="shopping"><i class="fas fa-shopping-cart"></i> Shopping</li>
            <li class="category-item" data-cat="email"><i class="fas fa-envelope"></i> Email</li>
            <li class="category-item" data-cat="work"><i class="fas fa-laptop"></i> Work</li>
            <li class="category-item" data-cat="gaming"><i class="fas fa-gamepad"></i> Gaming</li>
          </ul>
        </div>

        <div style="margin-top:16px" class="panel">
          <strong>Security</strong>
          <p style="color:var(--muted);font-size:13px;margin-top:8px">Vault is encrypted locally using PBKDF2 + AES-GCM. Keep your master password safe.</p>
        </div>
      </aside>

      <!-- Main -->
      <main class="panel">
        <div class="content-header">
          <h2>My Passwords</h2>
          <div class="controls">
            <input id="quickFilter" placeholder="Filter (e.g. gmail)" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)">
            <button class="btn btn-primary small" id="addPasswordBtn"><i class="fas fa-plus"></i> New</button>
          </div>
        </div>

        <div id="passwordGrid" class="password-grid"></div>

        <div id="emptyState" class="empty hidden">
          <i class="fas fa-lock" style="font-size:42px;color:var(--muted)"></i>
          <h3 style="margin-top:12px">No passwords yet</h3>
          <p style="color:var(--muted)">Click ‚ÄúAdd‚Äù to create your first password.</p>
        </div>
      </main>
    </div>

    <footer class="note">
      Local-only vault ‚Äî to run on a live/static server simply upload this single file. For multi-device sync or strong guarantees use a trusted password manager.
    </footer>
  </div>

  <!-- Add/Edit modal -->
  <div id="entryModal" class="modal hidden" aria-hidden="true">
    <div class="modal-content">
      <h2 id="entryTitle">Add Password</h2>

      <div class="form-row">
        <label for="service">Service name</label>
        <input id="service" type="text" placeholder="Gmail, Amazon...">
      </div>

      <div class="form-row">
        <label for="url">Website URL</label>
        <input id="url" type="url" placeholder="https://">
      </div>

      <div class="form-row">
        <label for="user">Username / email</label>
        <input id="user" type="text" placeholder="username or email">
      </div>

      <div class="form-row">
        <label for="pw">Password
          <button id="genBtn" class="btn-outline small" style="margin-left:8px">Generate</button>
        </label>
        <div style="display:flex;gap:8px">
          <input id="pw" type="text" placeholder="password (visible while editing)">
          <button id="togglePw" class="action-btn" title="Show/hide"><i class="far fa-eye"></i></button>
        </div>
        <div style="margin-top:8px" class="strength-meter"><div id="strengthFill" class="strength-fill"></div></div>
      </div>

      <div class="form-row">
        <label for="categorySelect">Category</label>
        <select id="categorySelect">
          <option value="">General</option>
          <option value="banking">Banking</option>
          <option value="shopping">Shopping</option>
          <option value="email">Email</option>
          <option value="work">Work</option>
          <option value="gaming">Gaming</option>
        </select>
      </div>

      <div style="display:flex;justify-content:space-between;gap:8px">
        <button id="entryCancel" class="btn btn-outline small">Cancel</button>
        <button id="entrySave" class="btn btn-primary small">Save</button>
      </div>
    </div>
  </div>

<script>
/*
  SecurePass Vault (client-side) - single-file implementation.

  Storage layout (localStorage):
    - vault_salt : base64 salt used for PBKDF2
    - vault_data : base64 AES-GCM encrypted JSON (the vault)
    - vault_meta : JSON string (optional metadata like username)
*/

// Screenshot protection variables (must be declared early to avoid TDZ issues)
let screenshotProtectionActive = false;
let screenshotHandlers = {
  keyup: null,
  keydown: null,
  contextmenu: null,
  selectstart: null,
  visibilitychange: null,
  blur: null,
  focus: null,
  preventScreenshot: null
};

const selectors = {
  authModal: document.getElementById('authModal'),
  authTitle: document.getElementById('authTitle'),
  authSubmit: document.getElementById('authSubmit'),
  authCancel: document.getElementById('authCancel'),
  authUsername: document.getElementById('authUsername'),
  authPassword: document.getElementById('authPassword'),

  vaultArea: document.getElementById('vaultArea'),
  lockBtn: document.getElementById('lockBtn'),
  exportBtn: document.getElementById('exportBtn'),
  importBtn: document.getElementById('importBtn'),
  resetVaultBtn: document.getElementById('resetVaultBtn'),

  addBtn: document.getElementById('addBtn'),
  addPasswordBtn: document.getElementById('addPasswordBtn'),
  entryModal: document.getElementById('entryModal'),
  entryTitle: document.getElementById('entryTitle'),
  entrySave: document.getElementById('entrySave'),
  entryCancel: document.getElementById('entryCancel'),
  service: document.getElementById('service'),
  url: document.getElementById('url'),
  user: document.getElementById('user'),
  pw: document.getElementById('pw'),
  genBtn: document.getElementById('genBtn'),
  togglePw: document.getElementById('togglePw'),
  categorySelect: document.getElementById('categorySelect'),
  passwordGrid: document.getElementById('passwordGrid'),
  emptyState: document.getElementById('emptyState'),
  searchInput: document.getElementById('searchInput'),
  categories: document.getElementById('categories'),
  quickFilter: document.getElementById('quickFilter'),
  clearAllBtn: document.getElementById('clearAllBtn'),
  strengthFill: document.getElementById('strengthFill'),
  exportFileInput: null
};

// In-memory decrypted vault while unlocked
let vault = { entries: [] }; // { id, service, url, username, password, category, createdAt, updatedAt }
let cryptoKey = null;         // CryptoKey derived from master password
let currentlyEditingId = null; // id when editing

/* ---------- Utils: arrayBuffer <-> base64 ---------- */
function arrayBufferToBase64(buffer){
  let bytes = new Uint8Array(buffer), len = bytes.byteLength;
  let binary = '';
  for (let i=0;i<len;i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}
function base64ToArrayBuffer(base64){
  let binary = atob(base64);
  let len = binary.length;
  let bytes = new Uint8Array(len);
  for (let i=0;i<len;i++) bytes[i]=binary.charCodeAt(i);
  return bytes.buffer;
}
/* ---------- End utils ---------- */

/* ---------- Crypto helpers ---------- */
async function generateSalt(){
  const s = crypto.getRandomValues(new Uint8Array(16));
  return arrayBufferToBase64(s.buffer);
}
async function deriveKey(password, saltBase64){
  const salt = base64ToArrayBuffer(saltBase64);
  const pwUtf8 = new TextEncoder().encode(password);
  const baseKey = await crypto.subtle.importKey('raw', pwUtf8, 'PBKDF2', false, ['deriveKey']);
  const key = await crypto.subtle.deriveKey(
    { name:'PBKDF2', salt, iterations: 150000, hash:'SHA-256' },
    baseKey,
    { name:'AES-GCM', length:256 },
    false,
    ['encrypt','decrypt']
  );
  return key;
}
async function encryptData(key, obj){
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const encoded = new TextEncoder().encode(JSON.stringify(obj));
  const cipher = await crypto.subtle.encrypt({ name:'AES-GCM', iv }, key, encoded);
  const payload = {
    iv: arrayBufferToBase64(iv.buffer),
    data: arrayBufferToBase64(cipher)
  };
  return payload;
}
async function decryptPayload(key, payload){
  const iv = base64ToArrayBuffer(payload.iv);
  const cipher = base64ToArrayBuffer(payload.data);
  const plain = await crypto.subtle.decrypt({ name:'AES-GCM', iv: new Uint8Array(iv) }, key, cipher);
  const decoded = new TextDecoder().decode(plain);
  return JSON.parse(decoded);
}
/* ---------- End crypto ---------- */

/* ---------- localStorage helpers ---------- */
function saveEncryptedVault(encryptedPayload){
  localStorage.setItem('vault_data', JSON.stringify(encryptedPayload));
}
function saveSalt(salt){
  localStorage.setItem('vault_salt', salt);
}
function getSalt(){
  return localStorage.getItem('vault_salt');
}
function getEncryptedPayload(){
  const p = localStorage.getItem('vault_data');
  return p ? JSON.parse(p) : null;
}
function clearLocalVault(){
  localStorage.removeItem('vault_data');
  localStorage.removeItem('vault_salt');
  localStorage.removeItem('vault_meta');
}
/* ---------- End storage ---------- */

/* ---------- UI rendering ---------- */
function renderEntries(filterText='', categoryFilter=''){
  const list = vault.entries || [];
  let shown = list.filter(e=>{
    const q = filterText.trim().toLowerCase();
    if (q && !(e.service.toLowerCase().includes(q) || (e.username||'').toLowerCase().includes(q))) return false;
    if (categoryFilter && e.category !== categoryFilter) return false;
    return true;
  });

  selectors.passwordGrid.innerHTML = '';
  if (!shown.length){
    selectors.emptyState.classList.remove('hidden');
    return;
  }
  selectors.emptyState.classList.add('hidden');

  shown.forEach(entry=>{
    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `
      <div class="row" style="gap:8px">
        <div>
          <strong>${escapeHtml(entry.service)}</strong>
          <div style="color:var(--muted);font-size:13px">${escapeHtml(entry.username || '')}</div>
        </div>
        <div style="display:flex;gap:6px;align-items:center">
          <button class="action-btn small reveal" data-id="${entry.id}" title="Reveal"><i class="far fa-eye"></i></button>
          <button class="action-btn small copy" data-id="${entry.id}" title="Copy password"><i class="far fa-copy"></i></button>
          <button class="action-btn small edit" data-id="${entry.id}" title="Edit"><i class="fas fa-edit"></i></button>
          <button class="action-btn small del" data-id="${entry.id}" title="Delete"><i class="fas fa-trash"></i></button>
        </div>
      </div>
      <div style="margin-top:12px">
        <div class="password-value" id="pw_${entry.id}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
        <div style="margin-top:8px;color:var(--muted);font-size:12px">${entry.url ? `<a href="${escapeHtml(entry.url)}" target="_blank" style="color:var(--muted)">Visit</a>` : ''} <span style="float:right">${new Date(entry.updatedAt||entry.createdAt).toLocaleString()}</span></div>
      </div>
    `;
    selectors.passwordGrid.appendChild(el);
  });

  // attach handlers
  selectors.passwordGrid.querySelectorAll('.reveal').forEach(btn=>{
    btn.addEventListener('click', async ev=>{
      const id = Number(btn.dataset.id);
      const entry = vault.entries.find(e=>e.id===id);
      if (!entry) return;
      const container = document.getElementById('pw_'+id);
      // show password in plain text for a short time
      container.textContent = entry.password;
      setTimeout(()=>{ container.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' }, 6000);
    });
  });

  selectors.passwordGrid.querySelectorAll('.copy').forEach(btn=>{
    btn.addEventListener('click', async ev=>{
      const id = Number(btn.dataset.id);
      const entry = vault.entries.find(e=>e.id===id);
      if (!entry) return;
      try{
        await navigator.clipboard.writeText(entry.password);
        btn.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(()=>btn.innerHTML = '<i class="far fa-copy"></i>',1500);
      }catch(e){
        alert('Failed to copy. Your browser may not allow copying from clipboard in this context.');
      }
    });
  });

  selectors.passwordGrid.querySelectorAll('.edit').forEach(btn=>{
    btn.addEventListener('click', ev=>{
      const id = Number(btn.dataset.id);
      openEntryEditor(id);
    });
  });

  selectors.passwordGrid.querySelectorAll('.del').forEach(btn=>{
    btn.addEventListener('click', ev=>{
      const id = Number(btn.dataset.id);
      if (!confirm('Delete this entry? This cannot be undone.')) return;
      vault.entries = vault.entries.filter(e=>e.id!==id);
      saveAndRender();
    });
  });
}

function escapeHtml(s){ if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ---------- CRUD + save ---------- */
function createEntry(data){
  const id = Date.now() + Math.floor(Math.random()*999);
  return {
    id,
    service: data.service||'Untitled',
    url: data.url||'',
    username: data.username||'',
    password: data.password||'',
    category: data.category||'',
    createdAt: Date.now(),
    updatedAt: Date.now()
  };
}
function openEntryEditor(id=null){
  currentlyEditingId = id;
  selectors.entryModal.classList.remove('hidden');
  selectors.entryModal.setAttribute('aria-hidden','false');
  if (id==null){
    selectors.entryTitle.textContent = 'Add Password';
    selectors.service.value = '';
    selectors.url.value = '';
    selectors.user.value = '';
    selectors.pw.value = '';
    selectors.categorySelect.value = '';
  } else {
    selectors.entryTitle.textContent = 'Edit Password';
    const e = vault.entries.find(x=>x.id===id);
    if (!e) return alert('Entry not found');
    selectors.service.value = e.service;
    selectors.url.value = e.url;
    selectors.user.value = e.username;
    selectors.pw.value = e.password;
    selectors.categorySelect.value = e.category || '';
  }
  updateStrength();
}
function saveEntryFromForm(){
  const data = {
    service: selectors.service.value.trim(),
    url: selectors.url.value.trim(),
    username: selectors.user.value.trim(),
    password: selectors.pw.value,
    category: selectors.categorySelect.value
  };
  if (!data.service || !data.password || !data.username){
    if (!confirm('Some fields are empty. Save anyway?')===true) return;
  }
  if (currentlyEditingId==null){
    vault.entries.push(createEntry(data));
  } else {
    const e = vault.entries.find(x=>x.id===currentlyEditingId);
    if (!e) return alert('Entry missing');
    e.service = data.service; e.url=data.url; e.username=data.username; e.password=data.password;
    e.category = data.category; e.updatedAt = Date.now();
  }
  closeEntryEditor();
  saveAndRender();
}
function closeEntryEditor(){
  currentlyEditingId = null;
  selectors.entryModal.classList.add('hidden');
  selectors.entryModal.setAttribute('aria-hidden','true');
}
async function saveAndRender(){
  await persistVault();
  renderEntries(selectors.searchInput.value || selectors.quickFilter.value, getActiveCategory());
}
/* ---------- End CRUD ---------- */

/* ---------- Persistence: encrypt vault and save to localStorage ---------- */
async function persistVault(){
  if (!cryptoKey) throw new Error('No cryptoKey');
  const payload = await encryptData(cryptoKey, vault);
  saveEncryptedVault(payload);
}
/* ---------- End persistence ---------- */

/* ---------- Boot / Unlock / Register flow ---------- */
async function showAuthModal(isRegister=false){
  // Disable screenshot protection while in auth modal to avoid conflicts
  disableScreenshotProtection();
  selectors.authModal.classList.remove('hidden'); selectors.authModal.setAttribute('aria-hidden','false');
  selectors.authTitle.textContent = isRegister ? 'Create Master Password' : 'Unlock Your Vault';
  selectors.authPassword.value = '';
}
function hideAuthModal(){ selectors.authModal.classList.add('hidden'); selectors.authModal.setAttribute('aria-hidden','true'); }

async function unlockWithPassword(masterPw, usernameOpt=''){
  // Guard against empty password
  if (!masterPw || !masterPw.trim()) {
    return;
  }
  masterPw = masterPw.trim();
  
  // If no salt, this is registration: create salt and empty vault then save encrypted vault
  let salt = getSalt();
  if (!salt){
    salt = await generateSalt();
    saveSalt(salt);
    // derive key and create empty vault
    cryptoKey = await deriveKey(masterPw, salt);
    vault = { entries: [] };
    await persistVault();
    localStorage.setItem('vault_meta', JSON.stringify({ username: usernameOpt || '', createdAt: Date.now() }));
    hideAuthModal();
    selectors.vaultArea.style.display = '';
    renderEntries();
    updateLockButton();
    reEnableScreenshotProtection(); // Re-enable after unlock
    // Zero-out plaintext master password and clear input field
    try { masterPw = ''; } catch(e) {}
    try { selectors.authPassword.value = ''; } catch(e) {}
    return;
  }

  // existing vault: derive key and try decrypting
  try{
  const key = await deriveKey(masterPw, salt);
    const payload = getEncryptedPayload();
    
    if (!payload) {
      // weird: salt exists but payload not found -> create empty
      cryptoKey = key;
      vault = { entries: [] };
      await persistVault();
      hideAuthModal();
      selectors.vaultArea.style.display='';
      renderEntries();
      updateLockButton();
      reEnableScreenshotProtection(); // Re-enable after unlock
      return;
    }
    
    const decrypted = await decryptPayload(key, payload);
    cryptoKey = key;
    vault = decrypted;
    hideAuthModal();
    selectors.vaultArea.style.display='';
    renderEntries();
    updateLockButton();
    reEnableScreenshotProtection(); // Re-enable after unlock
    // Clear master password variable and input to avoid lingering plaintext in memory/UI
    try { masterPw = ''; } catch(e) {}
    try { selectors.authPassword.value = ''; } catch(e) {}
  }catch(err){
    console.error('Unlock error:', err);
    alert('Incorrect master password or corrupted vault.\n\nIf this persists, click the "Reset" button to start fresh.');
  }
}

/* ---------- Export / Import ---------- */
function exportVault(){
  const payload = getEncryptedPayload();
  if (!payload) return alert('No vault data to export');
  const blob = new Blob([JSON.stringify(payload)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'securepass-vault.json'; a.click();
  URL.revokeObjectURL(url);
}
function importVault(){
  // prompt user to choose a file
  const input = document.createElement('input');
  input.type='file'; input.accept='.json,application/json';
  input.onchange = (e)=>{
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev)=>{
      try{
        const payload = JSON.parse(ev.target.result);
        // minimal validation
        if (!payload.iv || !payload.data) throw new Error('Not an encrypted vault file');
        // replace local storage with imported payload (but require master password to unlock)
        saveEncryptedVault(payload);
        // if salt not present, prompt to set a new one? We keep existing salt if any. If no salt we warn user.
        if (!getSalt()){
          saveSalt(prompt('No salt found in local storage. Please generate a new salt? (OK to generate)') ? (()=>{const s=generateSalt(); s.then(v=>saveSalt(v)); return ''})() : '');
        }
        alert('Imported encrypted vault. You must unlock with the master password used to encrypt it.');
        lockVault();
      }catch(err){
        alert('Invalid file: ' + err.message);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function resetVault(){
  const confirmed = confirm('‚ö†Ô∏è WARNING: This will permanently delete ALL vault data including encrypted passwords and salt.\n\nYou will need to create a new vault from scratch.\n\nAre you absolutely sure?');
  if (!confirmed) return;
  
  const doubleConfirm = confirm('This action CANNOT be undone. All your passwords will be lost.\n\nClick OK to proceed with reset.');
  if (!doubleConfirm) return;
  
  // Clear all vault data
  localStorage.removeItem('vault_salt');
  localStorage.removeItem('vault_data');
  localStorage.removeItem('vault_meta');
  
  // Lock the vault
  cryptoKey = null;
  vault = { entries: [] };
  
  alert('‚úÖ Vault has been reset successfully!');
  
  // Return to homepage
  const homepage = document.getElementById('homepage');
  const vaultApp = document.getElementById('vaultApp');
  
  vaultApp.classList.remove('active');
  setTimeout(() => {
    homepage.style.display = 'flex';
    homepage.classList.remove('fade-out');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }, 100);
}

/* ---------- Lock / unlock UI ---------- */
function lockVault(){
  cryptoKey = null;
  vault = { entries: [] };
  selectors.vaultArea.style.display = 'none';
  updateLockButton();
  // Clear any auth input to avoid accidental reuse
  try { selectors.authPassword.value = ''; } catch(e) {}
}
function updateLockButton(){
  const locked = !cryptoKey;
  selectors.lockBtn.textContent = locked ? 'Unlock' : 'Lock';
}
async function handleLockBtn(){
  if (cryptoKey){
    if (!confirm('Lock the vault now?')) return;
    lockVault();
  } else {
    // show auth modal (unlock)
    showAuthModal(false);
  }
}

/* ---------- UI events ---------- */
selectors.authCancel.addEventListener('click', ()=>{ 
  hideAuthModal(); 
  // If user cancels, go back to homepage
  goHome();
});
selectors.authSubmit.addEventListener('click', async ()=>{
  const pw = selectors.authPassword.value.trim();
  const uname = selectors.authUsername.value.trim();
  if (!pw) return alert('Enter a master password');
  await unlockWithPassword(pw, uname);
});
selectors.lockBtn.addEventListener('click', handleLockBtn);
selectors.exportBtn.addEventListener('click', exportVault);
selectors.importBtn.addEventListener('click', importVault);
selectors.resetVaultBtn.addEventListener('click', resetVault);

selectors.addBtn.addEventListener('click', ()=>openEntryEditor(null));
selectors.addPasswordBtn.addEventListener('click', ()=>openEntryEditor(null));
selectors.entryCancel.addEventListener('click', closeEntryEditor);
selectors.entrySave.addEventListener('click', saveEntryFromForm);
selectors.genBtn.addEventListener('click', ()=>{
  selectors.pw.value = generateStrongPassword(16);
  updateStrength();
});
selectors.togglePw.addEventListener('click', ()=>{
  if (selectors.pw.type === 'text'){ selectors.pw.type='password'; selectors.togglePw.innerHTML='<i class="far fa-eye"></i>'; } else { selectors.pw.type='text'; selectors.togglePw.innerHTML='<i class="far fa-eye-slash"></i>'; }
});
selectors.searchInput.addEventListener('input', ()=> renderEntries(selectors.searchInput.value, getActiveCategory()));
selectors.quickFilter.addEventListener('input', ()=> renderEntries(selectors.quickFilter.value, getActiveCategory()));
selectors.clearAllBtn.addEventListener('click', ()=>{
  if (!confirm('Delete ALL entries and clear vault (this also removes encrypted data)?')) return;
  clearLocalVault();
  lockVault();
  alert('Vault cleared from local storage.');
});
document.getElementById('authPassword').addEventListener('keydown', (e)=>{ 
  if (e.key==='Enter') selectors.authSubmit.click();
});
document.getElementById('pw').addEventListener('input', updateStrength);

selectors.categories.querySelectorAll('.category-item').forEach(item=>{
  item.addEventListener('click', ()=>{
    selectors.categories.querySelectorAll('.category-item').forEach(i=>i.classList.remove('active'));
    item.classList.add('active');
    renderEntries(selectors.searchInput.value || selectors.quickFilter.value, getActiveCategory());
  });
});

/* ---------- Convenience helpers ---------- */
function getActiveCategory(){
  const active = selectors.categories.querySelector('.category-item.active');
  return active ? active.dataset.cat : '';
}
function generateStrongPassword(len=12){
  const set = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+~`|}{[]:;?><,./-=";
  let s = '';
  const rnd = crypto.getRandomValues(new Uint32Array(len));
  for (let i=0;i<len;i++){
    s += set[rnd[i] % set.length];
  }
  return s;
}
function updateStrength(){
  const p = selectors.pw.value || '';
  let score = 0;
  if (p.length >= 8) score += 30;
  if (/[A-Z]/.test(p)) score += 20;
  if (/[0-9]/.test(p)) score += 25;
  if (/[^A-Za-z0-9]/.test(p)) score += 25;
  score = Math.min(100, score);
  selectors.strengthFill.style.width = score + '%';
  selectors.strengthFill.className = 'strength-fill ' + (score < 50 ? 'strength-weak' : (score < 75 ? 'strength-medium' : 'strength-strong'));
}

/* ---------- Startup: if vault exists, prompt unlock, else register ---------- */
async function startup(){
  const salt = getSalt();
  const payload = getEncryptedPayload();
  if (!salt || !payload){
    // fresh: prompt to create master password (register)
    const shouldCreate = confirm('No existing vault found. Create a new vault and master password?');
    if (shouldCreate){
      showAuthModal(true);
    } else {
      // keep locked
      updateLockButton();
    }
  } else {
    // locked but data exists, prompt unlock
    showAuthModal(false);
  }
}

function escapeAttr(s){ if(!s) return ''; return s.replace(/"/g,'&quot;'); }

/* ---------- Save helper that also persists encrypted data (with current cryptoKey) ---------- */
async function persistVault(){
  if (!cryptoKey) { console.warn('persistVault: no key, skipping'); return; }
  const payload = await encryptData(cryptoKey, vault);
  saveEncryptedVault(payload);
}

/* Reassign persistVault reference used earlier */
window.persistVault = persistVault;

/* Save & render convenience */
async function saveAndRender(){
  await persistVault();
  renderEntries(selectors.searchInput.value || selectors.quickFilter.value, getActiveCategory());
}

/* ---------- Utility: attempt to read existing vault and keep locked ---------- */
(function init(){
  // Don't auto-start vault anymore - user clicks "Open Vault" button
  // Just initialize the UI state
  updateLockButton();
  // Don't init screenshot protection yet - will be enabled after first unlock
  // initScreenshotPrevention();
})();

/* ----------
   Screenshot Prevention Features
------------ */
// Screenshot protection variables are declared at the top of the script

function initScreenshotPrevention() {
  // Only create elements once
  if (!document.querySelector('.no-screenshot-warning')) {
    // Create warning element
    const warning = document.createElement('div');
    warning.className = 'no-screenshot-warning';
    warning.innerHTML = '‚ö†Ô∏è Screenshot Detected! Vault Locked for Security';
    document.body.appendChild(warning);
  }

  if (!document.querySelector('.screenshot-overlay')) {
    // Create screenshot overlay
    const overlay = document.createElement('div');
    overlay.className = 'screenshot-overlay';
    overlay.innerHTML = `
      <h1>üîí VAULT LOCKED</h1>
      <p>Screenshot/Recording detected for your security</p>
      <p style="font-size: 14px; color: #94a3b8;">Reload the page to unlock</p>
    `;
    document.body.appendChild(overlay);
  }

  // Add watermark only once
  if (!document.querySelector('.security-watermark')) {
    addSecurityWatermark();
  }

  // Enable protection
  enableScreenshotProtection();
}

function enableScreenshotProtection() {
  if (screenshotProtectionActive) return; // Already active
  
  const warning = document.querySelector('.no-screenshot-warning');
  const overlay = document.querySelector('.screenshot-overlay');

  // Detect Print Screen key
  screenshotHandlers.keyup = (e) => {
    if (e.key === 'PrintScreen' || e.keyCode === 44) {
      handleScreenshotAttempt(warning, overlay);
    }
  };
  document.addEventListener('keyup', screenshotHandlers.keyup);

  // Detect Windows + Shift + S (Windows Snipping Tool) and macOS screenshots
  screenshotHandlers.keydown = (e) => {
    if ((e.metaKey || e.key === 'Meta') && e.shiftKey && e.key === 's') {
      e.preventDefault();
      handleScreenshotAttempt(warning, overlay);
    }
    // Cmd/Ctrl + Shift + 3/4/5 (macOS screenshots)
    if ((e.metaKey || e.ctrlKey) && e.shiftKey && ['3', '4', '5'].includes(e.key)) {
      e.preventDefault();
      handleScreenshotAttempt(warning, overlay);
    }
  };
  document.addEventListener('keydown', screenshotHandlers.keydown);

  // Detect visibility change (might indicate screen recording)
  screenshotHandlers.visibilitychange = () => {
    if (document.hidden) {
      blurSensitiveContent(true);
    } else {
      blurSensitiveContent(false);
    }
  };
  document.addEventListener('visibilitychange', screenshotHandlers.visibilitychange);

  // Prevent right-click context menu
  screenshotHandlers.contextmenu = (e) => {
    e.preventDefault();
    return false;
  };
  document.addEventListener('contextmenu', screenshotHandlers.contextmenu);

  // Disable text selection on password fields
  screenshotHandlers.selectstart = (e) => {
    if (e.target.classList.contains('password-value')) {
      e.preventDefault();
      return false;
    }
  };
  document.addEventListener('selectstart', screenshotHandlers.selectstart);

  // Monitor for external screen recording software
  let lastFocusTime = Date.now();
  screenshotHandlers.blur = () => {
    lastFocusTime = Date.now();
    blurSensitiveContent(true);
  };
  window.addEventListener('blur', screenshotHandlers.blur);

  screenshotHandlers.focus = () => {
    const blurDuration = Date.now() - lastFocusTime;
    // Only prompt if vault is actually unlocked (has cryptoKey)
    if (blurDuration > 2000 && cryptoKey) {
      const shouldContinueBlur = !confirm('Window was inactive. Continue viewing sensitive data?');
      if (shouldContinueBlur) {
        lockVault();
      }
    }
    blurSensitiveContent(false);
  };
  window.addEventListener('focus', screenshotHandlers.focus);

  // Detect screen capture API (Chrome/Edge) - only override once
  if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia && !navigator.mediaDevices._screenshotProtectionEnabled) {
    const originalGetDisplayMedia = navigator.mediaDevices.getDisplayMedia;
    navigator.mediaDevices.getDisplayMedia = function() {
      handleScreenshotAttempt(warning, overlay);
      return Promise.reject(new Error('Screen recording blocked for security'));
    };
    navigator.mediaDevices._screenshotProtectionEnabled = true;
  }

  screenshotProtectionActive = true;
}

function disableScreenshotProtection() {
  if (!screenshotProtectionActive) return; // Already disabled
  
  // Remove all event listeners
  if (screenshotHandlers.keyup) document.removeEventListener('keyup', screenshotHandlers.keyup);
  if (screenshotHandlers.keydown) document.removeEventListener('keydown', screenshotHandlers.keydown);
  if (screenshotHandlers.contextmenu) document.removeEventListener('contextmenu', screenshotHandlers.contextmenu);
  if (screenshotHandlers.selectstart) document.removeEventListener('selectstart', screenshotHandlers.selectstart);
  if (screenshotHandlers.visibilitychange) document.removeEventListener('visibilitychange', screenshotHandlers.visibilitychange);
  if (screenshotHandlers.blur) window.removeEventListener('blur', screenshotHandlers.blur);
  if (screenshotHandlers.focus) window.removeEventListener('focus', screenshotHandlers.focus);
  
  screenshotProtectionActive = false;
}

function reEnableScreenshotProtection() {
  // Initialize elements if first time
  if (!document.querySelector('.no-screenshot-warning')) {
    initScreenshotPrevention();
    return; // initScreenshotPrevention already calls enableScreenshotProtection
  }
  
  // Called after vault is unlocked
  enableScreenshotProtection();
  
  // Hide the lock overlay if it's showing
  const overlay = document.querySelector('.screenshot-overlay');
  if (overlay) {
    overlay.style.display = 'none';
  }
  
  // Remove blur from any blurred content
  blurSensitiveContent(false);
  
  console.log('ÔøΩ Screenshot protection re-enabled after unlock');
}

function handleScreenshotAttempt(warning, overlay) {
  console.warn('‚ö†Ô∏è Screenshot attempt detected!');
  
  // Show warning
  warning.style.display = 'block';
  
  // Immediately blur all password fields
  document.querySelectorAll('.password-value').forEach(el => {
    el.classList.add('secure-blur');
  });

  // Lock the vault
  setTimeout(() => {
    overlay.style.display = 'flex';
    lockVault();
    
    // Clear clipboard
    if (navigator.clipboard) {
      navigator.clipboard.writeText('').catch(err => console.log('Clipboard clear failed'));
    }
  }, 500);

  // Auto-hide warning after 3 seconds
  setTimeout(() => {
    warning.style.display = 'none';
  }, 3000);
}

function blurSensitiveContent(shouldBlur) {
  document.querySelectorAll('.password-value').forEach(el => {
    if (shouldBlur) {
      el.classList.add('secure-blur');
    } else {
      el.classList.remove('secure-blur');
    }
  });
}

function addSecurityWatermark() {
  const watermark = document.createElement('div');
  watermark.className = 'security-watermark';
  watermark.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-45deg);
    font-size: 120px;
    color: rgba(220, 38, 38, 0.05);
    pointer-events: none;
    z-index: 1;
    user-select: none;
    font-weight: bold;
  `;
  watermark.textContent = 'CONFIDENTIAL';
  document.body.appendChild(watermark);
}

/* ----------
   Small helper: toString escape
------------ */

/* ----------
   Homepage Functions
------------ */
function startVault() {
  const homepage = document.getElementById('homepage');
  const vaultApp = document.getElementById('vaultApp');
  
  // Fade out homepage
  homepage.classList.add('fade-out');
  
  // After fade completes, hide homepage and show vault
  setTimeout(() => {
    homepage.style.display = 'none';
    vaultApp.classList.add('active');
    
    // Trigger startup flow
    checkVaultStatus();
  }, 500);
}

function scrollToFeatures() {
  const featuresSection = document.getElementById('features');
  featuresSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function resetVaultFromHome() {
  const salt = getSalt();
  const payload = getEncryptedPayload();
  
  if (!salt && !payload) {
    alert('‚ÑπÔ∏è No vault data found. Nothing to reset.\n\nClick "Open Vault" to create a new vault.');
    return;
  }
  
  const confirmed = confirm('‚ö†Ô∏è WARNING: This will permanently delete ALL vault data including:\n\n‚Ä¢ All saved passwords\n‚Ä¢ Encryption keys\n‚Ä¢ Salt and metadata\n\nThis action CANNOT be undone.\n\nAre you absolutely sure?');
  if (!confirmed) return;
  
  const doubleConfirm = confirm('Final confirmation:\n\nAll your passwords will be permanently lost.\n\nClick OK to proceed with reset, or Cancel to keep your data.');
  if (!doubleConfirm) return;
  
  // Clear all vault data
  localStorage.removeItem('vault_salt');
  localStorage.removeItem('vault_data');
  localStorage.removeItem('vault_meta');
  
  // Clear any in-memory data
  if (typeof cryptoKey !== 'undefined') cryptoKey = null;
  if (typeof vault !== 'undefined') vault = { entries: [] };
  
  alert('‚úÖ Vault has been reset successfully!\n\nYou can now click "Open Vault" to create a new vault with a new master password.');
  
  // Scroll to top smoothly
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function goHome() {
  if (cryptoKey) {
    const confirmed = confirm('Vault is currently unlocked. Lock it before going back to homepage?');
    if (!confirmed) return;
    lockVault();
  }
  
  const homepage = document.getElementById('homepage');
  const vaultApp = document.getElementById('vaultApp');
  
  // Fade out vault app
  vaultApp.classList.remove('active');
  
  // Show homepage
  setTimeout(() => {
    homepage.style.display = 'flex';
    homepage.classList.remove('fade-out');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }, 100);
}

function checkVaultStatus() {
  const salt = getSalt();
  const payload = getEncryptedPayload();
  
  if (!salt || !payload) {
    // Fresh start - show welcome message then auth modal
    setTimeout(() => {
      const shouldCreate = confirm('Welcome to SecurePass Vault! üîê\n\nCreate a strong master password to get started.\n\n‚ö†Ô∏è Important: Your master password cannot be recovered if forgotten.\n\nClick OK to continue.');
      if (shouldCreate) {
        showAuthModal(true);
      } else {
        updateLockButton();
      }
    }, 300);
  } else {
    // Existing vault - show unlock modal
    setTimeout(() => {
      showAuthModal(false);
    }, 300);
  }
}

// Override the original startup function to not auto-run
async function startup(){
  // This is now called from startVault() via checkVaultStatus()
  // Keeping empty to prevent auto-execution
}

// Check if user wants to go straight to vault (has existing data)
function shouldAutoStart() {
  const salt = getSalt();
  const payload = getEncryptedPayload();
  return salt && payload;
}

// On page unload, aggressively clear in-memory secrets where possible
window.addEventListener('beforeunload', () => {
  try { cryptoKey = null; } catch (e) {}
  try { selectors.authPassword.value = ''; } catch (e) {}
  try { vault = { entries: [] }; } catch (e) {}
});

</script>
</div> <!-- Close vaultApp -->
</body>
</html>
